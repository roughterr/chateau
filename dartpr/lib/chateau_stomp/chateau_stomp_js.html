<dom-module id="chateau-stomp-js">
    <template>
        <div>AWAWA</div>
    </template>
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                stompClient: {
                    type: Object
                    //observer: 'stompClientChanged'
                },
                //one must wrap a string into an array in order to make two same messages not equal objects
                lastMessage: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                },
                messagetosend: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true,
                    observer: 'messagetosendChanged'
                },
                commonchat: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                }
            },

            publish: {
                newMessage: null
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this.connect(null, null);
            },

            connect: function (e, detail) {
                console.log("connecting to stomp...");
                var socket = new SockJS('/hello/');
                this.stompClient = Stomp.over(socket);
                var client = this.stompClient;
                var chat = this.commonchat;
                this.stompClient.connect('ian', "ian", function (frame) {
//                    setConnected(true);
                    console.log('Connected: ' + frame);
                    client.subscribe('/topic/greetings', function (greeting) {
                        console.log('/topic/greetings got');
                        console.log(JSON.parse(greeting.body).content);
                    });
                    client.subscribe('/user/topic/greetings', function (greeting) {
                        console.log('/user/topic/greetings got');
                        console.log(JSON.parse(greeting.body).content);
                    });
                    client.subscribe('/commonchat-outcoming', function (greeting) {
                        console.log('/commonchat-outcoming got. JSON.parse(greeting.body).text is ' + JSON.parse(greeting.body).text);
                        this.fire("commonchat-outcoming", JSON.parse(greeting.body));
                        console.log("fired");
                    });
                });
            },

            ///The function sends a message from the user to the server.
            messagetosendChanged: function (newValue) {
                console.log("sending the message to the server: " + newValue);
//                this.stompClient.send("/app/bzzz", {}, JSON.stringify({'name': newValue}));
                this.stompClient.send("/app/commonchat-incoming", {}, JSON.stringify({'text': newValue}));
            }
        });
    </script>
    <script src="sockjs-0.3.4.js"></script>
    <script src="stomp.js"></script>
</dom-module>
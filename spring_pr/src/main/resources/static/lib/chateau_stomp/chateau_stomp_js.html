<dom-module id="chateau-stomp-js">
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                //A JavaScript function that is called when the client receives a new message from the server.
                got_message_function: {
                    type: Object
                },
                send_message_function: {
                    type: Object,
                    notify: true
                },
                // WebSocket connection to the server.
                _socket: {
                    type: Object
                },
                /** Map, where the key is a destination and value is an object that has the following fields:
                 * currentChannel - ID of the current channel. Possible values are: 0, 1;
                 * firstChannelWaitingMap - a map of messages that are waiting to be confirmed by the server and belong
                 *                          to the first channel;
                 * secondChannelWaitingMap - a map of messages that are waiting to be confirmed by the server and belong
                 *                           to the second channel;
                 * firstChannelLastMessageID - ID of the last message that has been sent to the first channel;
                 * secondChannelLastMessageID - ID of the last message that has been sent to the second channel.
                 * */
                _sent_messages: {
                    type: Object
                }
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this._connect(null, null);
                var element = this;
                //Sends a message to a group of users.
                this.send_message_function = function (messagemap) {
                    element.send_message_to_destination("group-chat", messagemap);
                    return null;
                };
                this._sent_messages = {};
            },
            /**
             * Connects to the server.
             * @param e
             * @param detail
             * @private
             */
            _connect: function (e, detail) {
                console.log("connecting to stomp...");
                this._socket = new WebSocket('ws://localhost:8080/hello/');
                var element = this;
                this._socket.onopen = function () {
                    console.log('opened.');
                    //element._socket.send("hello, server!");
                };
//                this._stompClient = Stomp.over(socket);
//                var element = this;
//                this._stompClient.connect('ian', "ian", function (frame) {
//                    //setConnected(true);
//                    console.log('Connected: ' + frame);
//                    element._stompClient.subscribe('/user/message2group', function (messageFromServer) {
//                        console.log('/user/message2group got.');
//                        var response = JSON.parse(messageFromServer.body);
//                        element._sent_messages[response.messageClientID].markAsRead();
//                    });
//                    element._stompClient.subscribe('/user/message2group-news', function (messageFromServer) {
//                        console.log('/user/message2group-news got.');
//                        element.got_message_function(JSON.parse(messageFromServer.body));
//                    });
//                });
            },

            /**
             * Sends a message to a specific destination. The function does not know anything about message delivery
             * strategy. After the message is sent, the [message] map contains the channel number and message number.
             * @param destination string with a destination
             * @param message map with a message
             */
            send_message_to_destination: function (destination, message) {
                // Get the current channel if it is present in the map. Set the current channel to 0 if it is absent.
                var destinationObj = this._sent_messages[destination];
                console.log("destinationObj: " + destinationObj);
                var element = this;
                if (destinationObj == null) {
                    destinationObj = {};
                    destinationObj.firstChannelWaitingMap = {};
                    destinationObj.secondChannelWaitingMap = {};
                    destinationObj.firstChannelLastMessageID = -1;
                    destinationObj.secondChannelLastMessageID = -1;
                    destinationObj.currentChannel = 0; //first channel
                    this._sent_messages[destination] = destinationObj;
                    this.send_message_to_destination(destination, message);
                } else {
                    message["channel"] = destinationObj.currentChannel;
                    var newMessageID;
                    var waitingMap;
                    if (destinationObj.currentChannel == 0) {
                        destinationObj.firstChannelLastMessageID++;
                        newMessageID = destinationObj.firstChannelLastMessageID;
                        waitingMap = destinationObj.firstChannelWaitingMap;
                    } else if (destinationObj.currentChannel == 1) {
                        destinationObj.secondChannelLastMessageID++;
                        newMessageID = destinationObj.secondChannelLastMessageID;
                        waitingMap = destinationObj.secondChannelWaitingMap;
                    }
                    message["destination"] = destination;
                    message["message-id"] = newMessageID;
                    // Adding a message map to the regisrer only after all fields are filled.
                    waitingMap[newMessageID] = message;
                    element._socket.send(JSON.stringify(message));
                }
            }
        });
    </script>
    <script src="sockjs-1.1.1.js"></script>
    <script src="stomp.js"></script>
</dom-module>
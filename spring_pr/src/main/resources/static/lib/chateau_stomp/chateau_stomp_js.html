<dom-module id="chateau-stomp-js">
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                _stompClient: {
                    type: Object
                },
                //The id of the last message that the client sent. The ID is generated by the client but not the server.
                _lastMessageClientId: {
                    type: Number
                },
                //A JavaScript function that is called when the client receives a new message from the server.
                got_message_function: {
                    type: Object
                },
                send_message_function: {
                    type: Object,
                    notify: true
                }
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this.connect(null, null);
                this._lastMessageClientId = 1;
                var element = this;
                //Sends a message to a group of users.
                this.send_message_function = function (messagemap) {
                    messagemap.messageClientId = element._lastMessageClientId;
                    element._lastMessageClientId++;
                    element._stompClient.send("/app/message2group", {}, JSON.stringify(messagemap));
                }
            },

            connect: function (e, detail) {
                console.log("connecting to stomp...");
                var socket = new SockJS('/hello/');
                this._stompClient = Stomp.over(socket);
                var element = this;
                this._stompClient.connect('ian', "ian", function (frame) {
                    //setConnected(true);
                    console.log('Connected: ' + frame);
                    element._stompClient.subscribe('/user/message2group', function (messageFromServer) {
                        console.log('/user/message2group got.');
                        element.got_message_function(JSON.parse(messageFromServer.body));
                    });
                });
            }
        });
    </script>
    <script src="sockjs-1.1.1.js"></script>
    <script src="stomp.js"></script>
</dom-module>
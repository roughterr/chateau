<dom-module id="chateau-stomp-js">
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                //A JavaScript function that is called when the client receives a new message from the server.
                got_message_function: {
                    type: Object
                },
                send_message_function: {
                    type: Object,
                    notify: true
                },
                // WebSocket connection to the server.
                _socket: {
                    type: Object
                },
                /**
                 * A map whose key is a destination and value is an object that has 4 fields:
                 * currentChannel, firstChannel, secondChannel, thirdChannel.
                 */
                _destination_message_ids_map: {type: Object}
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this._destination_message_ids_map = {};
                this._connect(null, null);
                var element = this;
                //Sends a message to a group of users.
                this.send_message_function = function (messagemap) {
                    element.send_message_to_destination("group-chat", messagemap);
                    return null;
                };
            },
            /**
             * Connects to the server.
             * @param e
             * @param detail
             * @private
             */
            _connect: function (e, detail) {
                console.log("connecting to stomp...");
                this._socket = new WebSocket('ws://localhost:8080/hello/');
                var element = this;
                this._socket.onopen = function () {
                    console.log('opened.');
                    //element._socket.send("hello, server!");
                };
//                this._stompClient = Stomp.over(socket);
//                var element = this;
//                this._stompClient.connect('ian', "ian", function (frame) {
//                    //setConnected(true);
//                    console.log('Connected: ' + frame);
//                    element._stompClient.subscribe('/user/message2group', function (messageFromServer) {
//                        console.log('/user/message2group got.');
//                        var response = JSON.parse(messageFromServer.body);
//                        element._sent_messages[response.messageClientID].markAsRead();
//                    });
//                    element._stompClient.subscribe('/user/message2group-news', function (messageFromServer) {
//                        console.log('/user/message2group-news got.');
//                        element.got_message_function(JSON.parse(messageFromServer.body));
//                    });
//                });
            },

            /**
             * Sends a message to a specific destination. The function does not know anything about message delivery
             * strategy. After the message is sent, the [message] map contains the channel number and message number.
             * @param destination string with a destination
             * @param message map with a message
             */
            send_message_to_destination: function (destination, message) {
                // Get the current channel if it is present in the map. Set the current channel to 0 if it is absent.
                var destinationObj = this._destination_message_ids_map[destination];
                console.log("destinationObj: " + destinationObj);
                var element = this;
                if (destinationObj == null) {
                    destinationObj = {};
                    destinationObj.currentChannel = 0; //first channel
                    this._destination_message_ids_map[destination] = destinationObj;
                    this.send_message_to_destination(destination, message);
                } else {
                    message["channel"] = destinationObj.currentChannel;
                    var channelObj = this._get_channel_by_index(destinationObj.currentChannel, destinationObj);
                    if (channelObj.lastSentMessageID == null) {
                        channelObj.lastSentMessageID = -1;
                    }
                    channelObj.lastSentMessageID++;
                    message["destination"] = destination;
                    message["message-id"] = channelObj.lastSentMessageID;
                    element._socket.send(JSON.stringify(message));
                }
            },
            /**
             * Returns an object that belong to a specific channel, from a more generic object.
             * Creates a channel object if it is absent.
             * @param channelIndex
             * @param destinationObj
             * @return {*}
             */
            _get_channel_by_index: function (channelIndex, destinationObj) {
                console.log("_get_channel_by_index started.");
                if (channelIndex == 0) {
                    if (destinationObj.firstChannel == null) {
                        var newObj = {};
                        destinationObj.firstChannel = newObj;
                        return newObj;
                    } else {
                        return destinationObj.firstChannel;
                    }
                } else if (channelIndex == 1) {
                    if (destinationObj.secondChannel == null) {
                        var newObj = {};
                        destinationObj.secondChannel = newObj;
                        return newObj;
                    } else {
                        return destinationObj.secondChannel;
                    }
                } else if (channelIndex == 2) {
                    if (destinationObj.thirdChannel == null) {
                        var newObj = {};
                        destinationObj.thirdChannel = newObj;
                        return newObj;
                    } else {
                        return destinationObj.thirdChannel;
                    }
                } else {
                    return 1 / 0;
                }
            }
        });
    </script>
    <script src="sockjs-1.1.1.js"></script>
    <script src="stomp.js"></script>
</dom-module>
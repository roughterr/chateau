<dom-module id="chateau-stomp-js">
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                //A JavaScript function that is called when the client receives a new message from the server.
                got_message_function: {
                    type: Object
                },
                send_message_function: {
                    type: Object,
                    notify: true
                },
                // WebSocket connection to the server.
                _socket: {
                    type: Object
                },
                // Map where key is a destination and value is number of the current channel (possible values are: 0, 1, 2)
                _current_channels_map: {
                    type: Object
                }
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this._current_channels_map = {};
                this._connect(null, null);
                var element = this;
                //Sends a message to a group of users.
                this.send_message_function = function (messagemap) {
                    element.send_message_to_destination("group-chat", {});
                    return null;
                };
            },
            /**
             * Connects to the server.
             * @param e
             * @param detail
             * @private
             */
            _connect: function (e, detail) {
                console.log("connecting to stomp...");
                this._socket = new WebSocket('ws://localhost:8080/hello/');
                var element = this;
                this._socket.onopen = function () {
                    console.log('opened.');
                    //element._socket.send("hello, server!");
                };
//                this._stompClient = Stomp.over(socket);
//                var element = this;
//                this._stompClient.connect('ian', "ian", function (frame) {
//                    //setConnected(true);
//                    console.log('Connected: ' + frame);
//                    element._stompClient.subscribe('/user/message2group', function (messageFromServer) {
//                        console.log('/user/message2group got.');
//                        var response = JSON.parse(messageFromServer.body);
//                        element._sent_messages[response.messageClientID].markAsRead();
//                    });
//                    element._stompClient.subscribe('/user/message2group-news', function (messageFromServer) {
//                        console.log('/user/message2group-news got.');
//                        element.got_message_function(JSON.parse(messageFromServer.body));
//                    });
//                });
            },

            /**
             * Sends a message to a specific destination. The function does not know anything about message delivery
             * strategy.
             * @param destination string with a destination
             * @param message map with a message
             */
            send_message_to_destination: function (destination, message) {
                // Get the current channel if it is present in the map. Set the current channel to 0 if it is absent.
                var currentChannel = this._current_channels_map[destination];
                console.log("currentChannel: " + currentChannel);
                var element = this;
                if (currentChannel == null) {
                    this._current_channels_map[destination] = 0;
                    this.send_message_to_destination(destination, message);
                } else {
                    message["channel"] = currentChannel;
                    message["destination"] = destination;
                    var messageID = 0; //TODO
                    message["message-id"] = messageID;
                    element._socket.send(JSON.stringify(message));
                    return messageID;
                }
            }
        });
    </script>
    <script src="sockjs-1.1.1.js"></script>
    <script src="stomp.js"></script>
</dom-module>
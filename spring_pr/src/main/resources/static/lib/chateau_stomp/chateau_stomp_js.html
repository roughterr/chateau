<dom-module id="chateau-stomp-js">
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                //The id of the last message that the client sent. The ID is generated by the client but not the server.
                _lastMessageClientId: {
                    type: Number
                },
                //A JavaScript function that is called when the client receives a new message from the server.
                got_message_function: {
                    type: Object
                },
                send_message_function: {
                    type: Object,
                    notify: true
                },
                //Map where a key is a message client ID.
                _sent_messages: {
                    type: Object
                },
                // WebSocket connection to the server.
                _socket: {
                    type: Object
                }
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this.connect(null, null);
                this._sent_messages = {};
                this._lastMessageClientId = 1;
                var element = this;
                //Sends a message to a group of users.
                this.send_message_function = function (messagemap) {
                    messagemap.messageClientID = element._lastMessageClientId;
//                    element._stompClient.send("/app/message2group", {}, JSON.stringify(messagemap));
                    element._socket.send('{ "destination": "group-chat", "content": "' + messagemap.content + '", "message-id": "0" }');
                    element._sent_messages[element._lastMessageClientId] = {};
                    var toReturn = element._sent_messages[element._lastMessageClientId];
                    element._lastMessageClientId++;
                    return toReturn;
                };
            },

            connect: function (e, detail) {
                console.log("connecting to stomp...");
                this._socket = new WebSocket('ws://localhost:8080/hello/');
                var element = this;
                this._socket.onopen = function () {
                    console.log('opened.');
                    element._socket.send("hello, server!");
                    //element._socket.send('{ "destination": "group-chat", "message": { "aw": "aw" } }');
                };
//                this._stompClient = Stomp.over(socket);
//                var element = this;
//                this._stompClient.connect('ian', "ian", function (frame) {
//                    //setConnected(true);
//                    console.log('Connected: ' + frame);
//                    element._stompClient.subscribe('/user/message2group', function (messageFromServer) {
//                        console.log('/user/message2group got.');
//                        var response = JSON.parse(messageFromServer.body);
//                        element._sent_messages[response.messageClientID].markAsRead();
//                    });
//                    element._stompClient.subscribe('/user/message2group-news', function (messageFromServer) {
//                        console.log('/user/message2group-news got.');
//                        element.got_message_function(JSON.parse(messageFromServer.body));
//                    });
//                });
            }
        });
    </script>
    <script src="sockjs-1.1.1.js"></script>
    <script src="stomp.js"></script>
</dom-module>
<dom-module id="chateau-stomp-js">
    <script>
        Polymer({
            is: 'chateau-stomp-js',

            properties: {
                _stompClient: {
                    type: Object
                },
                //The last group message that the server sent to the client.
                groupmessagefromserver: {
                    type: Object,
                    notify: true
                },
                groupmessagefromclient: {
                    type: Object,
                    observer: 'groupmessagefromclientChanged'
                },
                //The id of the last message that the client sent. The ID is generated by the client but not the server.
                _lastMessageClientId: {
                    type: Number
                }
            },

            ready: function () {
                console.log("chateau-stomp-js is ready.");
                this.connect(null, null);
                this._lastMessageClientId = 1;
            },

            connect: function (e, detail) {
                console.log("connecting to stomp...");
                var socket = new SockJS('/hello/');
                this._stompClient = Stomp.over(socket);
                var client = this._stompClient;
                var aw = this;
                this._stompClient.connect('ian', "ian", function (frame) {
                    //setConnected(true);
                    console.log('Connected: ' + frame);
                    client.subscribe('/user/message2group', function (messageFromServer) {
                        console.log('/user/message2group got.');
                        aw.groupmessagefromserver = JSON.parse(messageFromServer.body);
                    });
                    client.subscribe('/user/message2group/1', function (messageFromServer) {
                        console.log('/user/message2group/1 got.');
                        aw.groupmessagefromserver = JSON.parse(messageFromServer.body);
                    });
                });
            },
            /**
             * Listen to changes of variable groupmessagefromclient. Sends a message to a group of users.
             * @param newValue
             */
            groupmessagefromclientChanged: function (newValue) {
                newValue.messageClientId = this._lastMessageClientId;
                this._lastMessageClientId++;
                this._stompClient.send("/app/message2group/1", {}, JSON.stringify(newValue));
            }
        });
    </script>
    <script src="sockjs-1.1.1.js"></script>
    <script src="stomp.js"></script>
</dom-module>